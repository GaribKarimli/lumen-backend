version: '3.8'

networks:
  lumen-network:
    driver: bridge

volumes:
  postgres-data:
  minio-data:
  mongo-data:

services:
  # Your Lumen Application (Build from Dockerfile)
  lumen-app:
    build:
      context: .
      dockerfile: Dockerfile
    image: lumen-mobile-app:local
    container_name: lumen-app
    restart: unless-stopped
    ports:
      - "8324:8324"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
      - MAIL_HOST=${MAIL_HOST}
      - MAIL_PORT=${MAIL_PORT}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - NOTIFICATION_ENABLED=true
      - NOTIFICATION_EMAIL=${NOTIFICATION_EMAIL}
      - ALERT_CPU_THRESHOLD=80.0
      - ALERT_COOLDOWN_MINUTES=10
      - PORT=8324
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/lumen_db
      - SPRING_DATASOURCE_USERNAME=lumen_user
      - SPRING_DATASOURCE_PASSWORD=lumen_password
    networks:
      - lumen-network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: lumen-postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=lumen_db
      - POSTGRES_USER=lumen_user
      - POSTGRES_PASSWORD=lumen_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - lumen-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lumen_user -d lumen_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO
  minio:
    image: minio/minio:latest
    container_name: lumen-minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - lumen-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Mock Log Generator 1 - High CPU
  log-cpu-heavy:
    image: busybox:latest
    container_name: log-cpu-heavy
    restart: unless-stopped
    command: >
      sh -c "
      while true; do
        echo '[$(date)] [ERROR] High CPU usage detected! Current: 95%';
        echo '[$(date)] [WARN] Service response time: 2.5s';
        dd if=/dev/zero of=/dev/null bs=1M count=100 2>/dev/null;
        sleep 5;
      done
      "
    networks:
      - lumen-network

  # Mock Log Generator 2 - Normal App
  log-app-server:
    image: alpine:latest
    container_name: log-app-server
    restart: unless-stopped
    command: >
      sh -c "
      while true; do
        echo '[$(date)] [INFO] User login successful - user_id: 12345';
        echo '[$(date)] [INFO] API request: GET /api/users - Status: 200';
        echo '[$(date)] [DEBUG] Database query executed in 45ms';
        sleep 3;
      done
      "
    networks:
      - lumen-network

  # Mock Log Generator 3 - Errors
  log-error-service:
    image: alpine:latest
    container_name: log-error-service
    restart: unless-stopped
    command: >
      sh -c "
      while true; do
        echo '[$(date)] [ERROR] Connection timeout to external API';
        echo '[$(date)] [CRITICAL] Database connection pool exhausted!';
        sleep 8;
        echo '[$(date)] [INFO] Service recovered';
        sleep 12;
      done
      "
    networks:
      - lumen-network

  # Nginx Web Server
  nginx-web:
    image: nginx:alpine
    container_name: log-nginx-web
    restart: unless-stopped
    ports:
      - "8080:80"
    networks:
      - lumen-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: log-redis-cache
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - lumen-network

  # MongoDB
  mongo:
    image: mongo:7
    container_name: log-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin123
    volumes:
      - mongo-data:/data/db
    networks:
      - lumen-network

  # Worker Service
  worker-service:
    image: python:3.11-alpine
    container_name: log-worker-jobs
    restart: unless-stopped
    command: >
      sh -c "
      while true; do
        echo '[$(date)] [INFO] Job started: email_notification_batch';
        echo '[$(date)] [INFO] Processing 250 emails...';
        sleep 3;
        echo '[$(date)] [INFO] Job completed successfully';
        sleep 10;
      done
      "
    networks:
      - lumen-network

  # High Memory Usage
  log-memory-heavy:
    image: alpine:latest
    container_name: log-memory-heavy
    restart: unless-stopped
    command: >
      sh -c "
      while true; do
        echo '[$(date)] [WARN] Memory usage: 85%';
        dd if=/dev/zero of=/tmp/bigfile bs=1M count=50 2>/dev/null;
        sleep 10;
        rm -f /tmp/bigfile;
        sleep 5;
      done
      "
    networks:
      - lumen-network
